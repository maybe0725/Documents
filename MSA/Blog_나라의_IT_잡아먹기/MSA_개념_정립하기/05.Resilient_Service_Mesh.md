# [MSA 개념 정립하기] Resilient Service Mesh

<br/>

출처 - [나라의 IT 잡아먹기 / [MSA 개념 정립하기] Resilient Service Mesh](https://waspro.tistory.com/434?category=857035)

<br/>

본 포스팅에서는 마이크로서비스를 관리 및 운영하는 Service Mesh에 대해 알아보겠습니다.

마이크로서비스를 정의하는 여러가지 의미 중 "서비스 기능 자체만 독립적이고 간결하게 구현하고 외부에 API만 노출하는 것"
이라고 할때, Service Mesh는 바로 이 마이크로서비스를 외곽에서 관리 및 운영하는 체계입니다. Service Mesh를 구성하는 요소를 살펴보면

Service Discovery, Service Router, Configuration등이 있습니다.
즉 Service Mesh는 'API Mediation' 방법 중 하나로서, 컨테이너로 운영되는 마이크로서비스의 API Mediation을 위한 필요한 기술입니다.

대표적인 제품으로

|              |             오픈소스 직접 구현              |                                          상용 솔루션 활용                                          |                        Public Cloud 서비스                        |
| :----------: | :-----------------------------------------: | :------------------------------------------------------------------------------------------------: | :---------------------------------------------------------------: |
| Service Mesh | Netflix OSS<br/>Istio<br/>Linkerd<br/>Envoy | Pivotal PAS/PKA 제품에 MSA 관련<br/>오픈소스 패킹하여 제공<br/>(구현은 고객이 직접 해야 할 영역임) | AWS API Gateway<br/>ELB<br/>StepFunction<br/>Azure Service Fabric |

등이 있습니다.

- Netflix OSS (오픈 소스, Spring Cloud Netflix 및 Steeltoe 프레임 워크 포함), Istio (오픈 소스)

- Buoyant Linkerd (오픈 소스 및 상용 라이센스), HashiCorp Consul (오픈 소스 및 상업 라이센스), Lightbend Lagom (오픈 소스 및 상용 라이센스)

- Aspen Mesh (상업용, Istio 기반), Microsoft Azure 서비스 패브릭 (상업용), AVI 네트워크 (상업용), Red Hat OpenShift Service Mesh (미리보기 : Istio의 상용 배포판)

<br/>

OSS를 사용할 경우 기술 자유도와 자산화를 할 수 있다는 장점이 있지만, MSA를 구현하기 위한 노력과 투자가 필요하며, CSP의 경우 MSA를 구현하기 쉽고 인프라를 CSP에서 관리 해 줄수 있다는 차이가 있습니다.
상용 솔루션은 그 중간 정도로 개발 가이드와 컨설팅이 제공되어 MSA를 구현해 나갈 수 있습니다.

지금부터 살펴 볼 다양한 Service Mesh의 활용 방안을 알아보고, 다양한 아키텍처 패턴을 도출해 보도록 하겠습니다.

<br/>

**1) Service Mesh 정의**

Service Mesh는 Miniservice 및 Microservice 환경 내에서 보안, 확장성 및 가용성을 향상시킵니다.
서비스 메시(Metric)는 디지털 플랫폼을 지원하는 클라우드 기반 인프라의 핵심 요소입니다.

① 서비스 메시 기술은 동적 발견을 지원하고 트래픽을 가로 채고 정책을 적용함으로써 마이크로 서비스 간의 통신 제어를 제공합니다.

② 마이크로 서비스 - 마이크로 서비스 통신의 경우 서비스메시가 다른 중재 기술 (예 : 기존로드 밸런서 및 API 게이트웨이)보다 선호됩니다.

③ 서비스 메시 기술은 빠르게 발전하고 있으며 상업용 및 오픈 소스 솔루션을 비롯한 여러 가지 옵션을 사용할 수 있습니다.

<br/>

**2) Service Mesh 활용**

Service Mesh를 채택하여 안전하고 탄력적인 Miniservice 및 Microservice 구성할 수 있습니다.

① 사이드카 프록시와 같은 공급 업체 종속(lock-in)을 감소시키는 접근방식을 선호하여 특정 서비스 메시 기술에 대한 코드 의존을 제한합니다.

② 네트워킹 메시징, 보안 및 개발팀과 협력하고 입력을 요구하는 여러 기능을 갖춘 PlatformOps 팀에 서비스 메시 소유권을 할당하여 문제 및 논쟁을 줄입니다.

<br/>

Service Mesh는 마이크로서비스 인프라의 중요한 부분으로, 응용 프로그램의 복원력과 보안을 향상시킬 수 있습니다.
이는 서비스간의 통신과 관련된 기능을 자동화함으로써 개발자의 부담을 줄입니다.

또한, Service Mesh는 응용 프로그램 서비스 간의 통신을 최적화하는 분산 컴퓨팅 미들웨어입니다.
서비스 간 통신을 위한 프록시 역할 또는 경량 조정을 제공하고 인증, 권한 부여, 암호화, 서비스 검색, 요청 라우팅, 로드 밸런싱, 자가 치유 복구 및 서비스 계측과 같은 기능을 지원합니다.

<br/>

마이크로서비스 환경에서 모놀리식이었던 응용 프로그램은 독립적인 구성요소로 분리되어 분산형 서비스로 배포됩니다.
일반적으로 임시적이고 동적으로 확장 가능한 관리 컨테이너 시스템으로 배포됩니다.
서비스 인스턴스는 필요에 따라 시작, 중지, 삭제, 재구성 또는 대체 될 수 있습니다.
결과적으로 이러한 서비스에는 동적 발견 및 자가 치유 연결을 동적이며 안정적인 방식으로 서로 통신 할 수 있는 통신 미들웨어가 필요합니다.
이것이 바로 서비스메시입니다.

<br/>

![images](images/20191120-1216-03.png)

[그림 1] 서비스메시 기능 @ 2018 Gartner, Inc.

<br/>

서로 통신하기 위한 서비스 요구사항은 새로운 것이 아닙니다.
그러나 마이크로서비스의 크기, 규모 및 일시적인 성격으로 인해 궁극적으로 응용 프로그램 제공 컨트롤러, 로드균형 Controller 및 API 게이트웨이와 같은 기존 방식에서 벗어난 가볍고 빠른 기술이라 할 수 있습니다.

<br/>

**3) Service Mesh 용도**

현재 서비스메시에는 Kubernetes, PaaS (Platform as a Service) 또는 유사 탄력적으로 확장 가능한 환경과 같은 관리 컨테이너 클러스터 내의 Miniservice 및 Microservice에 대한 서비스 간 통신관리가 있습니다.

㉠ 관리 컨테이너 시스템 (예 : Kubernetes, Mesos 및 Docker Swarm)

㉡ 컨테이너 (Amazon Web Services [AWS] Fargate 및 Google Kubernetes Engine과 같은 서비스 환경)

㉢ 공용 및 개인 PaaS 환경 (예 : OpenShift Online, Heroku 및 Pivotal Cloud Foundry)

㉣ 비교 가능한 관리 컴퓨팅 환경 (예 : Azure Service Fabric 및 Lightbend Reactive Platform)

<br/>

서비스 메시의 핵심 기능은 트래픽을 가로 채고 정책을 적용하는 기능을 포함하여 트래픽 관리 기능을 제공하는 것입니다.
이는 복잡한 분산 컴퓨팅 문제를 관리하여 개발자의 부담을 줄이고 생산성을 향상시키는 데 도움이됩니다.
또한 트래픽 관리를 통해 다음과 같은 몇 가지 추가적인 이점을 얻을 수 있습니다.

ⓐ 가용성 / 탄력성 : 서비스메시는 자체 치유를 가능하게 하고 계단식 오류를 방지하는 Bulkhead 및 Circuit Breaker와 같은 안정성 및 탄력성 패턴을 지원합니다.

ⓑ 동적 / 확장성 : 서비스메시는 분산 된 클러스터에서 서비스 구성을 관리합니다. 또한 서비스 인스턴스의 동적 발견을 지원하고, 카나리아, A/B 및 Blue/Green 배치를 가능하게 하는 다른서비스 버전에 대한 요청 라우팅을 지원하며, 클러스터 내의 인스턴스 간에 로드밸런싱을 지원합니다. 로드밸런싱은 용량이 필요할 때 서비스 확장을 지원하여 확장성을 향상시킵니다.

ⓒ 계측 / 가시성 : 서비스메시는 서비스 간 상호작용을 자동으로 계측하고 각 서비스 호출을 자동으로 계측 할 수 있으므로 어떤 서비스가 사용 가능한지 (서비스 검색)와 어떤 서비스가 서로 통신 하는지를 파악합니다. 메트릭을 모니터링, 추적 및 분석 도구로 라우팅 할 수 있습니다. 이 계측은 로깅, 종속성 추적, 진단 및 디버깅을 가능하게 합니다.

ⓓ 보안 : 서비스 메시는 서비스가 서로 통신 할 때 (일반적으로 액세스 토큰의 유효성 검사를 통해) 경량의 인증 및 권한 부여를 지원합니다. 또한 메시지 암호화를 지원하고 TLS 키 생성 또는 외부 키 저장소와의 통합을 포함하여 암호화 키를 관리하는 데 도움이 됩니다.

<br/>

**4) Service Mesh 성장**

서비스메시 기술의 성장은 마이크로서비스 및 컨테이너의 성장과 관련되어 있습니다.
현대 응용프로그램은 갈수록 분산되고 컨테이너화 되어 서비스메시 기술의 관심과 채택을 촉진합니다.

<br/>

![images](Oops!)

[그림 2] 증가하는 서비스메시 비율 @ 2018 Gartner, Inc.

<br/>

서비스메시 기술은 초기에 마이크로 서비스를 채택한 사람들이 위와 같은 새로운 기능을 필요로하여 탄생하였습니다.
클라이언트와 서비스간의 조정을 제공하는 전통적인 API 게이트웨이 기술은 마이크로 서비스간 통신에 비해 너무 무겁고 마이크로서비스 팀은 더 가벼운 솔루션이 필요했습니다.

개발 된 최초의 서비스메시 기술 중 하나는 단편적인 Netflix OSS 공통 런타임 서비스 및 라이브러리 (Ribbon, Hystrix, Eureka 및 Zuul과 같은 구성 요소 포함)입니다.
다른 초기 얼리 어댑터들은 Twitter, Airbnb, Lyft 등에 서비스메시 기술을 구축했습니다.
Microsoft는 Azure Service Fabric 프레임 워크의 일부인 서비스 메시를 구축 한 최초의 공급 업체 중 하나였습니다.
Buoyant는 트위터 초기 작업을 기반으로 Linkerd를 개발 한 다른 초기 벤더였습니다.

서비스메시 기술에 대한 고객의 관심은 2017 년 초 Google, IBM, Lyft가 Kubernetes에서 실행되는 마이크로서비스를 위한 서비스 메시 프레임 워크를 제공하기 위해 Istio 오픈 소스 프로젝트를 시작하면서 가속화되었습니다.
Istio v1.0은 2018년 7월에 출시되었으며, Kubernetes 기반 플랫폼의 수많은 공급 업체는 상용 Istio 기반 제품을 출시 할 계획입니다.
Cloud Foundry 기반 플랫폼 공급 업체 중 다수가 Istio를 Cloud Foundry에 이식하기 위해 노력하고 있습니다.

<br/>

**5) Service Mesh 유의점**

미성숙, lock-in 및 스킬요구를 포함하여 서비스메시 기술을 사용하는 데는 여러 가지 위험이 있습니다.

㉠ 미비 : 서비스메시 기술은 비교적 새롭고 미성숙합니다. 예를 들어, Istio와 Linkerd는 빠르게 발전하고 있으며 얼리 어답터는 안정성, 성능 및 확장성에 대한 우려를 보고합니다. 또한 서비스메시를 지원하는데 필요한 문서화 및 관리를 비롯하여 최상의 운영 방식이 확립되지 않았습니다.

㉡ Lock-in : 서비스메시는 특히 프레임 워크 또는 라이브러리 기반 솔루션을 사용할 때 lock-in이 결정됩니다. Linkerd 또는 Istio와 같은 사이드 카 패턴을 사용하여 배치되는 서비스메시는 lock-in을 감소시키기 때문에 좋습니다.

㉢ 기술력 보유 : 대부분의 기업은 서비스메시 기술에 대한 경험이 없으며 필요한 전문 지식이 유기적으로 개발하기 쉽지 않은지 확실하지 않습니다.

<br/>

**6) 다양한 Service Mesh 비교**

서비스메시의 선택은 Miniservice 및 Microservice를 호스팅하는 플랫폼, 사용 된 서비스 간 통신 프로토콜 및 마이크로서비스를 구축하는 데 사용된 모든 프레임워크에 종속됩니다.
또한 서비스 코드가 메시와 얼마나 밀접하게 결합되어 있는지, 서비스 코드가 메시에 대해 인식하고 있는 정도를 고려해야 합니다.
Microsoft Azure Service Fabric 및 Lightbend Lagom과 같은 일부 메시기술은 개발 프레임워크의 일부이며 메시는 서비스코드에 포함됩니다.
Netflix OSS와 같은 일부 메시기술은 라이브러리로 구현되며 서비스는 API 호출을 통해 메시에 결합됩니다.
Istio 및 Linkerd와 같은 일부 메시기술은 사이드 코드 프록시를 사용하여 메시기능을 서비스 상호 작용에 주입하여 서비스 코드를 메시와 독립적으로 사용할 수 있게 합니다.

<br/>

![images](Oops!)

[그림 3] 코드 결합에 기반한 서비스메시 기술의 스펙트럼 @ 2018 Gartner, Inc.

<br/>

위 이미지는 서비스 메시의 lock-in 정도 및 Service Code와의 종속성을 보여주는 스펙트럼입니다.
프레임워크기반 메시는 개발자가 잘 설계된 서비스를 구축하는데 도움이되지만 프레임 워크와 런타임 환경과의 긴밀한 결합을 유발합니다.
사이드카 기반 메쉬는 개발자 가드 레일을 제공하지 않지만 관리 및 유지보수가 쉬우며 런타임 정책을 구성할 수 있는 보다 융통성있는 방법을 제공합니다.

<br/>

지금부터 대표 Service Mesh 제품 중 CSP 사의 AWS App Mesh와 OSS Istio를 비교해 보도록 하겠습니다.

<br/>

**① AWS App Mesh**

https://aws.amazon.com/ko/app-mesh/features/

AWS Fargate, Amazon ECS, Amazon EKS, Kubernetes on EC2와 함께 App Mesh를 사용하면 규모에 맞춰 컨테이너화 된 마이크로서비스를 효과적으로 사용할 수 있습니다.

㉠ 일관된 마이크로서비스 통신 : App Mesh는 통신 모니터링과 제어에 필요한 논리를 각각의 마이크로서비스 대한 모든 네트워크 트래픽을 관리하는 프록시로 나눕니다.

㉡ 오픈소스 프록시 : App Mesh는 마이크로서비스 컨테이너로 오가는 모든 트래픽을 관리하기 위해 오픈소스인 Envoy 프록시를 설정합니다.

㉢ 가시성 : App Mesh는 마이크로서비스 간 모든 통신에 대한 수치, 로그, 트레이스를 모으기 때문에 에러 발생 부분을 빠르게 처리할 수 있습니다. 이 기능은 AWS 서비스와 오픈 소스를 이용해 수행할 수 있습니다.

㉣ 트래픽 제어 : App Mesh는 어플리케이션 내부 코드 수정이나 로드밸런서를 사용하는 일 없이 마이크로서비스들을 바로 연결할 수 있도록 합니다. 각 아미크로서비스가 시작할 때, 마이크로서비스의 프록시가 App Mesh에 연결하고 어플리케이션 내 다른 마이크로서비스들의 위치를 담고 있는 데이터를 받습니다.

<br/>

**② Istio**

https://istio.io/docs/concepts/what-is-istio/

㉠ 트래픽 관리 : Istio의 간단한 룰 설정과 트래픽 라우팅은 사용자로 하여금 서비스 간 트래픽과 API 요청의 흐름을 조절할 수 있게 합니다. Istio는 circuit breakers, timeouts, retries 같은 서비스 레벨의 속성들의 설정을 단순화 하고, A/B Testing, Canary Rollouts, 백분위 단위의 traffic 분산으로 단계적 rollouts 같은 중요한 일들을 설정하기 쉽도록 합니다.

㉡ 보안 : Istio의 보안 기능을 통해 개발자들은 응용프로그램 단계의 보안에 집중할 수 있습니다. Istio는 기본 보안 통신채널을 제공하고, 규모에 따른 서비스 통신의 인증, 권한부여, 암호화를 관리합니다.

㉢ 관측 : Istio의 강력한 tracing, monitoring 그리고 logging은 service mesh 배포에 대한 깊은 통찰력을 제공합니다. 서비스 성능이 업스트림과 다운스트림에 어떤 영향을 끼치는지를 Istio의 모니터링 기능을 통해서 확인 할 수 있습니다.

㉣ 플랫폼 지원 : Istio는 플랫폼에 독립적이고, 다양한 클라우드, On-premise, Kubernetes, Mesos 같은 다양한 환경에서 돌아가도록 설계 되었습니다.

㉤ 통합 및 사용자 정의 : Istio의 정책 실행 구성요소는 ACLs, Logging, Monitoring, Quotas, Auditing 그 외의 기존의 솔루션들과 통합되도록 확장 및 사용자 정의가 될 수 있습니다.

<br/>

마이크로서비스를 배치 할 때 서비스메시는 반드시 필요하며 실행 가능한 대안이 없다고 할 수 있습니다.
기술적으로 서비스메시를 배치 할 수는 있지만 서비스 수가 늘어남에 따라 운영상의 지원 및 확장이 극히 어렵기 때문이죠.

다른 비슷한 제품 (API 게이트웨이 및 애플리케이션 딜리버리 컨트롤러)도 충분하지 않습니다. 이러한 제품은 종종 서비스메시와 함께 사용해야 합니다.

특히 ADC, 로드밸런서 및 API 게이트웨이는 응용 프로그램 앞에 클라이언트와 통신방식을 제공하고, 서비스메시는 내부 서비스 간 통신을 지원는 방식으로 구성할 것을 예상합니다.

다음 시간에는 Service Discovery에 대해 살펴보겠습니다.
